{
    "collab_server" : "",
    "contents" : "source(\"Code/00_Functions.R\")\n\n#########################\n##### Before start #####\n########################\n# 1. This code compares Meta-analysis results with Carr study \n\n# 2. Please set the working directory to \"MetaCyto_Paper_Code\" folder\n\n# 3. Please make sure you have already run code 03, 04, and 05.\n\n# 4. Note: The column names of the meta-data in ImmPort studies may change between\n# data releases. Please change the code accordingly. \n\n#########################\n##### Prepare data #####\n########################\n# Find age related cell population in ImmPort data\nfiles1=list.files(\"Result/05_search_output_population\",pattern=\"cluster_stats_in_each_sample\",recursive=T,full.names=T)\nfcs_stats=collectData(c(files1),longform=T)\n\n#join the cluster data with age data and label_name\nfiles=list.files(\"Result\",pattern=\"03_sample_info\",recursive=T,full.names=T)\nsample_info=collectData(files,longform=F)\nall_data=inner_join(fcs_stats,sample_info,by=\"fcs_files\")\nuser_data=fread(\"Data/FCS_SDY311.txt\",data.table=F)\nuser_data$label=gsub(\"DNA1\\\\+&DNA2\\\\+\\\\||CD14-&CD33-\\\\|\",\"\",user_data$label,fixed = F)\nlabel_name=user_data[,c(\"label\",\"Name\")]\nall_data=inner_join(all_data,label_name,by=\"label\")\nall_data=all_data[!grepl(\"cluster\",all_data$Name),]\nall_data=all_data[all_data$parameter_name==\"fraction\",]\nall_data=all_data[all_data$BIOSAMPLE_TYPE_NAME==\"PBMC\",]\nall_data=all_data[all_data$RACE == \"White\",]\n\n####################################################\n##### Estimate effect size using meta-analysis #####\n####################################################\n# estimate effects for all variables\nall_result=NULL\n\nGA=glmAnalysis(value=\"value\",variableOfInterst=\"SUBJECT_AGE\",parameter=\"fraction\",\n               otherVariables=c(\"GENDER\"),studyID=\"study_id\",label=\"label\",\n               data=all_data,CILevel=0.95,ifScale=c(T,F))\nGA = GA[order(GA$Effect_size),]\nGA=cbind(GA,\"Parameter_name\"=\"fraction\")\nall_result=rbind(all_result,GA)\n\nall_result=inner_join(all_result,unique(all_data[,c(\"label\",\"Name\")]),by=\"label\")\n\n\n\n####################################################\n##### Estimate effect size using carr data #########\n####################################################\n# Find age related cell population in liston data \nliston_data=read.csv(\"Data/Liston_data_%_PBMC.csv\",check.names=F,stringsAsFactors=F)\nliston_data=gather(liston_data,key=Name,value=value,`B cells`:`Bswitch`)\nliston_data=liston_data[,c(\"PatientID\",\"Sex\",\"Ageattimeofsampling.years.\",\"Name\",\"value\")]\nliston_data=cbind(liston_data,'parameter_name'=\"fraction\",\"study_id\"=\"liston\")\nliston_data=na.omit(liston_data)\nnames(liston_data)=c(\"subjectID\",\"GENDER\",\"AGE\",\"Name\",\"value\",\"parameter_name\",\"study_id\")\nliston_result=NULL\nGA=glmAnalysis(value=\"value\",variableOfInterst=\"AGE\",parameter=\"fraction\",\n               otherVariables=c(\"GENDER\"),studyID=\"study_id\",label=\"Name\",\n               data=liston_data,CILevel=0.95,ifScale=c(T,F))\nGA=cbind(GA,\"Parameter_name\"=\"fraction\")\nliston_result=rbind(liston_result,GA)\nnames(liston_result)[1]=\"Name\"\nliston_result=cbind(liston_result,\"p_adjust\"=p.adjust(liston_result$p_value,method=\"BH\"))\n\n################\n##### Plot #####\n################\n\ncombine_result=inner_join(liston_result,all_result,by=\"Name\")\ncombine_result$Name=c(\"B cell\",\"CD4 T\",\n                      \"naive CD4\",\"CD4 T-EM\",\n                      \"CD4 T-CM\",\"Treg\",\n                      \"CD8 T\",\"naive CD8\",\n                      \"CD8 T-CM\",\"CD8 T-EM\",\n                      \"NKT\",\"NK\",\n                      \"memory B\",\"naive B\")\n\n# plot using ggrepel\ncombine_result = cbind(combine_result, \"p.adj\"=p.adjust(combine_result$p_value.x,method=\"BH\"))\n\np= ggplot(combine_result, aes(x=`Effect_size.y`, y=`Effect_size.x`,label=Name))+\n  geom_point(size=5,aes(col=factor(p.adj>0.05)))+ \n  geom_label_repel(aes(x=`Effect_size.y`, y=`Effect_size.x`,label = Name),\n                   box.padding = unit(0.5, \"lines\"),\n                   label.size = NA,fill=NA,color=\"grey40\",\n                   point.padding = unit(0.5, \"lines\"))+\n  geom_hline(yintercept=0)+geom_vline(xintercept=0)+\n  xlab('Effect size of age from MetaCyto')+ ylab('Effect Size of Age in Carr study')+\n  theme_set(theme_gray(base_size = 18))+\n  theme(legend.position='none')+\n  ylim(-0.025,0.02)+xlim(-0.025,0.02)\nplot(p) \n",
    "created" : 1503440290090.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "730418697",
    "id" : "587A657B",
    "lastKnownWriteTime" : 1503440307,
    "last_content_update" : 1503440307330,
    "path" : "~/Desktop/Local_Projects/MetaCyto_Paper/MetaCyto_Paper_Code/Code/10_Meta_analysis_validate_with_Carr.R",
    "project_path" : "Code/10_Meta_analysis_validate_with_Carr.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}